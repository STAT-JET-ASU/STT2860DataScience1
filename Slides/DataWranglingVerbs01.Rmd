---
title: "Data Wrangling, Part 1: dplyr Verbs for Columns"
author: "Author: Jill E. Thomley"
date: "`r format(Sys.time(), '%A, %B %d, %Y @ %I:%M %p')`"
output: 
  ioslides_presentation:
    logo: images/logoASU.jpg
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  comment = NA
)
```

## Before We Begin...

These slides are not meant to be standalone information. You should take notes to flesh out the contents. I recommend that you create an R Markdown document where you can combine information and code from the slides and your own additional notes and explorations to make connections.

**Related Materials**

* Modern Dive [Chapter 3: Data Wrangling](https://moderndive.com/3-wrangling.html)
* Modern Dive [Chapter 4: Data Importing and “Tidy” Data](https://moderndive.com/4-tidy.html)
* DataCamp [Introduction to the Tidyverse](https://learn.datacamp.com/courses/introduction-to-the-tidyverse)
* DataCamp [Data Manipulation with dplyr](https://learn.datacamp.com/courses/data-manipulation-with-dplyr)
* Data Wrangling, Part 2: [dplyr](https://dplyr.tidyverse.org/reference/index.html) Verbs for Rows [slides](https://stat-jet-asu.github.io/STT2860DataScience1/Slides/DataWranglingVerbs02.html)

# Review: Datasets

## Dataset Structure

* A ***variable*** is some characteristic of interest that can differ between individuals in a population.

* An observational unit (or ***observation***) is a single individual, object, or entity about which collect data, regarding one or more of its characteristics (variables).

* An observation may be called a case, subject, or participant.

* Ideally, each observational unit has a value for each variable.

A ***dataset*** is a collection of data values for the observations and variables in a study (e.g., survey or experiment). A common way to arrange data is to put variables in columns and observations in rows. This is what we call ***tidy*** data. 

## Tidy Data

<p style="text-align:center; font-size: 18px;"><img src="https://d33wubrfki0l68.cloudfront.net/6f1ddb544fc5c69a2478e444ab8112fb0eea23f8/91adc/images/tidy-1.png" width = 775><br>
Tidy data graphic from [R for Data Science: Tidy Data](http://r4ds.had.co.nz/tidy-data.html)</p>

<p>Many datasets are already in tidy format, though there may be missing data and other issues we have to address before doing data analysis and visualization.</p>

<p>Real life data is usually far messier and can require a great deal of tidying. The dplyr verbs help us to get data into tidy format and to modify it in other ways, such as creating new variables.</p>

## Exploring Structure

A few functions for exploring dataset structure are given below. 

* `glimpse()` # requires tidyverse
* `attributes()`
* `dim()` # dimensions, rows &times; columns
* `names()`
* `nrow()`
* `ncol()`
* `head()`
* `tail()`
* `sum(complete.cases())` # this is two nested functions
* `sum(!complete.cases())` # what does the ! do?

## Example Dataset

* Statistician Francis Galton (1822-1911), a cousin of Charles Darwin, studied the relationship between parents' heights and the heights of their offspring. His pioneering [1886 article](https://galton.org/essays/1880-1889/galton-1886-jaigi-regression-stature.pdf) is the first appearance of regression analysis in print. 

* The `galtonfamiliesall` dataset we will be working with was [partly reconstructed by Dr. James A. Hanley](http://www.medicine.mcgill.ca/epidemiology/hanley/galton/) and his students from [original paper notebooks](http://www.medicine.mcgill.ca/epidemiology/hanley/galton/notebook/index.html) containing handwritten data for 205 families that was gathered by Galton. 

* Galton's made comments about how he "transmuted" some of the data for analysis. As with most historical data, gender is a binary variable for both parents and children.

## Read in the Data

You can access the Galton data file from the [description](https://stat-jet-asu.github.io/Datasets/InstructorDescriptions/galtonheightdata.html) page, which also contains more context and variable definitions.

```{r, echo = FALSE}
library(tidyverse)
galtondata <- read_csv("https://raw.githubusercontent.com/STAT-JET-ASU/Datasets/master/Instructor/galtonfamiliesall.csv")
```

```{r}
head(galtondata)
```

Question: Why is familyID a character variable?

##

What are the variable names?

```{r}
names(galtondata)
```

How many observations are there?

```{r}
nrow(galtondata)
```

Are there any cases with `NA` values?

```{r}
sum(!complete.cases(galtondata))
```

# dplyr Verbs for Variables<br>(Manipulating Columns)

## 

* [`mutate()`](https://dplyr.tidyverse.org/reference/mutate.html) / [`transmute()`](https://dplyr.tidyverse.org/reference/mutate.html)

Use to create, modify, and/or delete columns (variables).

* [`pull()`](https://dplyr.tidyverse.org/reference/pull.html)

Use to extract a single column (variable) into a vector.

* [`rename()`](https://dplyr.tidyverse.org/reference/rename.html)

Use to rename columns (variables).

* [`relocate()`](https://dplyr.tidyverse.org/reference/relocate.html)

Use to change the order of columns.

* [`select()`](https://dplyr.tidyverse.org/reference/select.html)

Use to subset columns; can also change order or rename.

## Mutating Mother Height

Galton "transmuted the female statures to their corresponding male equivalents" by multiplying them by `1.08`. We can do this for the variable `Mother` by using [`mutate()`](https://dplyr.tidyverse.org/reference/mutate.html) to create `MotherT`. 

```{r}
galtondataA <- galtondata %>%
  mutate(MotherT = 1.08 * Mother)
head(galtondataA, n = 5)
```

## Mutating Daughter Height

Both daughters' and sons' heights are stored in `Height`. We can `mutate()` conditionally for daughters using [`if_else()`](https://dplyr.tidyverse.org/reference/if_else.html).

```{r}
galtondataA <- galtondataA %>%
  mutate(HeightT = if_else(Child == "Daughter", 1.08 * Height, Height))
head(galtondataA)
```

## Computing Midparent Height

Galton also calculated the midpoint of the parents' heights. 

```{r}
galtondataA <- galtondataA %>%
  mutate(Midparent = (Father + MotherT) / 2)
head(galtondataA, n = 5)
```

## All Variables in One `mutate()`

You can create all three variables in one `mutate()` statement.

```{r}
galtondataB <- galtondata %>%
  mutate(
    MotherT = 1.08 * Mother,
    HeightT = if_else(Child == "Daughter", 1.08 * Height, Height),
    Midparent = (Father + MotherT) / 2
  )
```

Next you could pipe (`%>%`) this into a `select()` step to reduce the number of variables in the dataset, or perform some other other operation. The output is always a tibble.

In general, our data manipulations may contain several steps, depending on the format of the original data and our goals in terms of any research questions and data analyses.

## Are They The Same?

```{r}
identical(galtondataA, galtondataB)
```

```{r}
all.equal(galtondataA, galtondataB)
```

In this case, our choice of manipulation(s) produced the exact same final dataset structure.

First develop code that works for your goals, one step at a time, then you can rearrange and condense to make your code more readable, reproducible, and efficient.

## What if we use `transmute()`?

The [`transmute()`](https://dplyr.tidyverse.org/reference/transmute.html) function deletes all columns *except* for those included in `transmute()`. (**note:** this function is *superseded*)

```{r}
galtondataC <- galtondata %>%
  transmute(
    Father,
    MotherT = 1.08 * Mother,
    Midparent = (Father + MotherT) / 2,
    HeightT = if_else(Child == "Daughter", 1.08 * Height, Height)
  )
head(galtondataC, n = 1)
```

## Using `select()`

We can use [`select()`](https://dplyr.tidyverse.org/reference/select.html) to choose a subset of our columns. For example, the variables `Midparent` and `HeightT` would help us recreate Galton's original work.

```{r}
galtondataD <- galtondataA %>%
  select(
    FamilyID,
    Midparent,
    HeightT
  )
head(galtondataD, n = 1)
```

## Multipurpose `select()`

We can choose columns, reorder, and rename at the same time with `select()`. The order in which columns are selected will be their new order. Rename by assigning `newname = oldname`.

```{r}
galtondataD <- galtondataA %>%
  select(
    family_id = FamilyID,    # change to lowercase and _ name
    ht_parent = Midparent,   # change to more consistent name
    ht_child = HeightT       # change to more consistent name
  )
head(galtondataD, n = 1)
```

## UN-`select()`

Sometimes the list of variables to get rid of is shorter than the list to keep. We can use `select()` to delete unwanted columns instead of listing columns to keep by using `-`. 

```{r}
galtondataE <- galtondataA %>%
  select(
    -Mother,   # delete Mother, since we have the mutated MotherT
    -Height    # delete Height, since we have the mutated HeightT
  )
head(galtondataE, n = 1)
```

## Using `relocate()`

The [`relocate()`](https://dplyr.tidyverse.org/reference/relocate.html) function moves columns, using syntax similar to `select()`. Recall that in `galtondataA`, the new variables we made with `mutate()` were placed after the existing variables.

```{r}
galtondataF <- galtondataA %>% 
  relocate(MotherT, .after = Mother) %>% 
  relocate(Midparent, .after = MotherT)
head(galtondataF, n = 1)
```

Sometimes we move columns to take advantage of block/group functions, like specifying a range of columns.

## `relocate()` Multiple Columns

You can also `select()` or `relocate()` a block or set of columns together, using some common criteria they all share.

For example, I can move all the numeric variables to the front of the dataset using [`where()`](https://tidyselect.r-lib.org/reference/where.html). You can also use a function such as [`starts_with()`](https://tidyselect.r-lib.org/reference/starts_with.html) or `contains()` to choose variables by name(s).

```{r}
galtondataG <- galtondata %>% 
  relocate(where(is.numeric))
head(galtondataG, n = 1)
```

## Another `relocate()` Example

```{r}
head(galtondataD, n = 1)
```

```{r}
galtondataH <- galtondataD %>% 
  relocate(starts_with("ht"))   # variables with ht moved to front
head(galtondataH, n = 1)
```

## Another `relocate()` Example

```{r}
head(galtondataF, n = 1)
```

```{r}
galtondataJ <- galtondataF %>% 
  relocate(Child:HeightT)   # columns Child through HeightT to front
head(galtondataJ, n = 1)
```

## Note: Functions Altered Only Columns

Note: All the datasets include the same number of rows (934).

```{r}
dim(galtondata) # original data, 6 variables total
dim(galtondataA) # used mutate to add 3 new variables to original
dim(galtondataB) # used mutate to add 3 new variables to original
```

##

```{r}
dim(galtondataC) # used transmute to add variables / delete some old
dim(galtondataD) # used select to choose 3 variables to keep
dim(galtondataE) # used select to remove 2 of 9 variables 
dim(galtondataF) # using relocate to reorder 9 variables
```

##

```{r}
dim(galtondataG) # using relocate to reorder 6 variables
dim(galtondataH) # using relocate to reorder 3 variables
dim(galtondataJ) # using relocate to reorder 9 variables
```

<hr>

Overall, make a plan for the variables you need, then consider how to get them from the variables you have. 

